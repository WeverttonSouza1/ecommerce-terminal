@startuml
skinparam handwritten true
skinparam ClassAttributeIconStyle none
scale 0.85

' =================================
' PACKAGES DE INFRAESTRUTURA (CORE/DOMAIN)
' =================================

package core {
    abstract class EntidadeBase {
        # id: Long
    }
    
    class Produto extends EntidadeBase {
        - id: Long
        - nome: String
        - descricao: String
        - preco: BigDecimal
        - estoque: int
        - status: String
        + isAtivo(): boolean
    }
    
    class ItemPedido {
        - produto: Produto
        - quantidade: int
        - precoUnitario: BigDecimal
        + calcularSubtotal(): BigDecimal
    }

    class Pedido extends EntidadeBase {
        - clienteId: Long
        - enderecoEntrega: String
        - itens: List<ItemPedido>
        - dataCriacao: LocalDateTime
        - status: String
        - total: BigDecimal
        - state: PedidoState
        + adicionarItem(item: ItemPedido): void
        + calcularTotal(): void
        + mudarEstadoPara(novoStatus: String): void
    }

    Pedido "1" *-- "0..*" ItemPedido
    ItemPedido "1" o-- "1" Produto
}

package domain {
    class Carrinho {
        - itens: List<ItemPedido>
        + adicionar(produto: Produto, qtd: int): void
        + removerPorProdutoId(produtoId: Long): void
        + total(): BigDecimal
        + limpar(): void
        + exibirCarrinho(): void
    }
    Carrinho "1" *-- "0..*" ItemPedido
}

' =================================
' PACKAGES DESINGN PATTERNS
' =================================

package factoryMethod {
    interface PagamentoInterface {
        + processarPagamento(valor: BigDecimal): boolean
    }
    
    class PagamentoFactory <<Factory>> {
        + {static} criarPagamento(tipo: String): PagamentoInterface
    }
    
    PagamentoFactory ..> PagamentoInterface : creates
    
    class PagamentoBoleto implements PagamentoInterface
    class PagamentoCartao implements PagamentoInterface
    class PagamentoPix implements PagamentoInterface
}

package state {
    interface PedidoState {
        + exibirStatus()
    }

    class PedidoProcessando implements PedidoState
    class PedidoEnviado implements PedidoState
    class PedidoEntregue implements PedidoState
    class PedidoCancelado implements PedidoState

    Pedido "1" o-- "1" PedidoState
}

package observer {
    class NotificacaoProduto {
        - mensagem: String
        - data: LocalDateTime
    }
    
    interface Observer {
        + update(notificacao: NotificacaoProduto): void
    }
    
    Observer ..> NotificacaoProduto
}

' =================================
' PACKAGES DE USUÁRIOS
' =================================

package user {
    abstract class Usuario extends EntidadeBase {
        - nome: String
        - email: String
        - senha: String
    }

    class Cliente extends Usuario implements Observer {
        - endereco: String
        - favoritos: List<Long>
        - mensagemRepo: MensagemRepository
        + update(msg: NotificacaoProduto): void
    }
    
    class Administrador extends Usuario {
    }
}

' =================================
' PACKAGES DE REPOSITÓRIO (PERSISTÊNCIA)
' =================================

package repository {
    class UsuarioRepository {
        - idGen: AtomicLong
        + LoadLastId(): Long
        + salvarUsuario(u: Usuario): void
        + buscarPorId(id: Long): Optional<Usuario>
        + buscarPorEmail(email: String): Optional<Usuario>
        + buscarClientesPorIds(ids: List<Long>): List<Cliente>
        + ListarUsuarios(): List<Usuario>
    }
    
    class GerenciadorDeArquivos {
        + LoadLastId(p: Path): Long    
        + carregarProdutos(): List<Produto>
        + salvarProduto(p: Produto): Produto
        + buscarProdutoPorId(id: Long): Optional<Produto>
        + deletarProduto(id: Long): void
        + reescreverArquivoProdutos(produtos: List<Produto>): void
        + carregarPedidos(): List<Pedido>
        + salvarPedido(pedido: Pedido)
        + buscarPedidoPorId(id: Long): Optional<Pedido>
        + salvarPedidoComStatus(pedido: Pedido): void
        + formatarPedidoParaLinha(pedido: Pedido): String
    }
    
    class ObserverRepository <<Subject State>> {
        - produtoId: Long
        - clientesObservadores: List<Long>
        + adicionarObservador(produtoId: Long, clienteId: Long)
        + recuperarObservadores(produtoId: Long): List<Long>
        + removerObservadoresDoProduto(produtoId: Long): void
        + buscarEntry(lista: List<ProdutoObservado>,produtoId: Long): Optional<ProdutoObservado
        + carregarTodosObservadores(): List<ProdutoObservado>
        + salvarTodosObservadores(List<ProdutoObservado> lista): void
    }

    class MensagemRepository {
        + arquivoCliente(c: Cliente): Path
        + enviarMensagem(cliente: Cliente, remetente: String, conteudo: String): void
        + listarMensagens(cliente: Cliente): List<String>
        + limparMensagens(cliente: Cliente): void
    }

    Cliente o-- MensagemRepository
}

' =================================
' PACKAGES DE VIEW (INTERFACES)
' =================================

package view {
    class InputUtils {
        + {static} lerInt(sc: Scanner, mensagem: String): int
        + {static} lerLong(sc: Scanner, mensagem: String): Long
        + {static} lerBigDecimal(sc: Scanner, mensagem: String): BigDecimal
    }

    class Loja {
        - usuarioRepo: UsuarioRepository
        + iniciar(): void
        - login(): void
        - cadastrar(): void
        - verCatalogo(): void
    }
    
    class MenuCliente {
        - cliente: Cliente
        - arquivo: GerenciadorDeArquivos
        - msgRepo: MensagemRepository
        - observerRepo: ObserverRepository
        - usuarioRepo: UsuarioRepository
        - carrinho: Carrinho
        + iniciar(): void
        - listarProdutos: void
        - verCarrinho(): void
        - adicionarProdutoAoCarrinho(): void
        - finalizarCompra(): void
        - editarDados(): void
        - assinarNotificacaoEstoque(): void
        - caixaMensagens(): void
        - historicoPedidos(): void
    }
    
    class PainelAdministrador {
        - admin: Administrador
        - arquivo: GerenciadorDeArquivos
        - msgRepo: MensagemRepository
        - usuarioRepo: UsuarioRepository
        - observerRepo: ObserverRepository
        + iniciar()
        - cadastrarProduto(): void
        - editarProduto(): void
        - notificarObservadores(p: Produto): void
        - removerProduto(): void
        - listarProduto(): void
        - listarPedido(): void
        - alterarStatusPedido(): void
        - enviarMensagemCliente: void
    }
    
    ' Dependências de InputUtils
    MenuCliente ..> InputUtils
    PainelAdministrador ..> InputUtils

    ' Associações/Dependências da Loja
    Loja ..> UsuarioRepository
    Loja ..> GerenciadorDeArquivos
    Loja --> MenuCliente
    Loja --> PainelAdministrador

    ' Associações/Dependências do MenuCliente
    MenuCliente o-- Cliente
    MenuCliente o-- Carrinho
    MenuCliente ..> GerenciadorDeArquivos
    MenuCliente ..> ObserverRepository
    MenuCliente ..> PagamentoFactory
    MenuCliente ..> Pedido

    ' Associações/Dependências do PainelAdministrador (Gatilho do Observer)
    PainelAdministrador o-- Administrador
    PainelAdministrador ..> GerenciadorDeArquivos
    PainelAdministrador ..> ObserverRepository : <<Notifica>>
    PainelAdministrador ..> UsuarioRepository : <<Busca Observadores>>
    PainelAdministrador ..> MensagemRepository : <<Notifica Status>>
    PainelAdministrador ..> Pedido
}
@enduml